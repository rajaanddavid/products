<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>

    <style>
        /* Make iframe take full viewport */
        html, body {
          margin: 0;
          padding: 0;
          height: 100%;
          overflow: hidden;
        }
        #product-frame {
          width: 100%;
          height: 100%;
          border: none;
        }
    </style>

</head>
<body>

<iframe id="product-frame" src=""></iframe>

<script>
    (function() {
        // --- Get product path from query string ---
        const params = new URLSearchParams(window.location.search);
        const productPath = params.get('product'); // e.g., 'product/leash' or 'cat-shelf-guide'
        if (!productPath) {
            document.body.innerHTML = '<h1>Error: no product specified</h1>';
            return;
        }

        const pageHash = ((window.location.hash || '').substring(1).split('?')[0] || '').toLowerCase();

        // --- Redirect logic ---
        function isMobile() { return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent); }
        function isAndroid() { return /Android/i.test(navigator.userAgent); }
        function isIOS() { return /iPhone|iPad|iPod/i.test(navigator.userAgent); }
        function isAppBrowser() { return /Instagram|FBAV|FBAN\/FBIOS|FB_IAB|FB4A|Threads|Barcelona/i.test(navigator.userAgent); }
        function isFacebookBrowser() { return /FBAN\/FBIOS|FBAV|FB_IAB|FB4A/i.test(navigator.userAgent); }

        // Run after iframe loads
        const iframe = document.getElementById('product-frame');
        iframe.src = '/' + productPath; // load original product page

        iframe.addEventListener('load', function() {
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;

                // Update entry title if needed
                const entryHeader = doc.querySelector('.entry-title');
                if (entryHeader) {
                    if (isAppBrowser()) {
                        if (isAndroid()) entryHeader.textContent = "Redirecting... please continue";
                        else if (isIOS()) {
                            if (isFacebookBrowser()) entryHeader.textContent = "Redirecting... please open app";
                            else entryHeader.textContent = "Redirecting... please wait";
                        }
                    } else if (isAndroid()) entryHeader.textContent = "Allow or tap again";
                    else if (isIOS()) entryHeader.textContent = "Redirecting... please wait";
                }

                // Update affiliate links inside iframe
                fetch('/amazonLinks.json')
                    .then(res => res.json())
                    .then(amazonLinks => {
                        const productLinks = amazonLinks[productPath] || {};
                        if (!productLinks || !Object.keys(productLinks).length) return;

                        // Update buttons
                        const buttons = doc.querySelectorAll('.wp-block-button.buy-button .wp-block-button__link');
                        const linkKeys = Object.keys(productLinks);
                        buttons.forEach((btn, index) => {
                            if (index === 0 && pageHash && productLinks[pageHash]) {
                                btn.href = productLinks[pageHash];
                            } else {
                                const key = linkKeys[index] || linkKeys[0];
                                btn.href = productLinks[key];
                            }
                        });

                        // Update extra links
                        doc.querySelectorAll('a[title^="extralink"]').forEach(link => {
                            try {
                                const linkKey = link.getAttribute('title').toLowerCase();
                                if (productLinks && linkKey && productLinks[linkKey]) {
                                    link.href = productLinks[linkKey];
                                }
                            } catch(e) { console.warn('Invalid extralink', link); }
                        });

                        // If hash matches a target link, handle mobile redirect
                        const targetKey = pageHash && productLinks[pageHash] ? pageHash : null;
                        const targetLink = targetKey ? productLinks[targetKey] : null;
                        if (targetLink && isMobile()) {
                            const script = document.createElement('script');
                            script.src = "https://rum.auditzy.com/bcBFmvug-products.outdoorsavannah.com-iar.js";
                            script.async = true;
                            document.head.appendChild(script);

                            script.onload = function() {
                                sessionStorage.setItem('redirected', 'true');
                                setTimeout(() => {
                                    if (isAndroid()) window.open(targetLink, '_blank');
                                    else window.location.href = targetLink;
                                }, 2000);
                            };

                            script.onerror = function() {
                                setTimeout(() => { window.location.href = targetLink; }, 2000);
                            };
                        }
                    })
                    .catch(err => console.error('Failed to load Amazon links:', err));

            } catch(e) {
                console.warn('Unable to access iframe content (check same-origin).', e);
            }
        });

    })();
</script>

</body>
</html>
